#!/bin/bash
# nano .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit

set -e

echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ —Ñ–∞–π–ª—ã –≤ /secrets/ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ SOPS..."

has_errors=0

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ secrets/
FILES=$(git diff --cached --name-only | grep '^secrets/' || true)

for file in $FILES; do
  [[ ! -f "$file" ]] && continue
  [[ "$file" == *.gitkeep ]] && continue
  [[ "$(basename "$file")" == "README.md" ]] && continue

  # –ü–æ–ª—É—á–∞–µ–º JSON —Å—Ç–∞—Ç—É—Å
  status_json=$(sops filestatus "$file" 2>/dev/null || echo '{"encrypted":false}')

  # –ü—Ä–æ–≤–µ—Ä–∫–∞, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —Ñ–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω
  is_encrypted=$(echo "$status_json" | jq -r '.encrypted' 2>/dev/null)

  if [[ "$is_encrypted" != "true" ]]; then
    echo "‚ùå $file –ù–ï –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ SOPS (—Å—Ç–∞—Ç—É—Å: $status_json)"
    has_errors=1
  fi
done

if [[ "$has_errors" -ne 0 ]]; then
  echo "üõë –ö–æ–º–º–∏—Ç –ø—Ä–µ—Ä–≤–∞–Ω: –Ω–∞–π–¥–µ–Ω—ã –ù–ï–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ /secrets/"
  exit 1
fi

echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–æ–º–º–∏—Ç."